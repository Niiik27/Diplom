<header class="header">
    {% load static %}
    <div class="container">

        <div class="avatar ">
            {% if user.is_authenticated == False %}
            <a href="{% url 'home' %}" class="username">Главная</a>
            {% else %}
            <a href="{% url 'profile' username=request.user.username %}" class="username">{{ request.user.username
                }} </a>
            <a href="{% url 'profile' username=request.user.username %}edit" class="" type="button">Редактировать</a>
            {% endif %}
        </div>


        <div id="menu">
            {% if user.is_authenticated == False %}
            <a href="{% url 'login' %}" class="" type="button">Вход</a>
            {% else %}

            <a href="{% url 'users'  %}" type="button">Пользователи <span id="users">0</span></a>
            <a href="{% url 'profile' 'logout' %}" class="" type="button">Выход</a>

            {% if user.is_staff %}
            <a href="{% url 'admin:index' %}" class="admin" type="button">Админка</a>
            {% endif %}
            {% endif %}
        </div>
    </div>
    {% if user.is_authenticated %}
    <script>

        const notifySocket = new WebSocket('ws://127.0.0.1:8002/ws/notify/');

        notifySocket.onopen = function () {
            console.log('notifySocket connection established.');
            // requestTotalNotify();
        };
        notifySocket.onclose = function () {
            console.log('notifySocket connection closed.');
        };

        notifySocket.onmessage = function (event) {
            console.log('notifySocket onmessage');
            let data = JSON.parse(event.data);
            if(data.type==='set_statuses'){
                console.log("incomingNotify",data);
                console.log("incomingNotify",data.statuses);
                setStatuses(data.statuses);
            }
            else if(data.type==='total')
            {
                addUnreadNum(data.num);
                console.log('Пришло уведомление о количестве сообщений',data.num,data.type);
            }

        };

        // function requestTotalNotify() {
        //     notifySocket.send(JSON.stringify({'type': 'total'}));
        // }

        function addUnreadNum(count) {
            let usersContainer = document.getElementById('users');
            usersContainer.textContent = count;
        }
    </script>

    {% endif %}
</header>